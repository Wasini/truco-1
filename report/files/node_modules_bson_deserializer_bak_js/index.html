<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/bson/deserializer_bak.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/bson/deserializer_bak.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">65.65</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">357</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">50.96</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.48</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&quot;use strict&quot;

var writeIEEE754 = require(&#039;../float_parser&#039;).writeIEEE754,
	readIEEE754 = require(&#039;../float_parser&#039;).readIEEE754,
	f = require(&#039;util&#039;).format,
	Long = require(&#039;../long&#039;).Long,
  Double = require(&#039;../double&#039;).Double,
  Timestamp = require(&#039;../timestamp&#039;).Timestamp,
  ObjectID = require(&#039;../objectid&#039;).ObjectID,
  Symbol = require(&#039;../symbol&#039;).Symbol,
  Code = require(&#039;../code&#039;).Code,
  MinKey = require(&#039;../min_key&#039;).MinKey,
  MaxKey = require(&#039;../max_key&#039;).MaxKey,
  DBRef = require(&#039;../db_ref&#039;).DBRef,
  BSONRegExp = require(&#039;../regexp&#039;).BSONRegExp,
  Binary = require(&#039;../binary&#039;).Binary;

var BSON = {};

/**
 * Contains the function cache if we have that enable to allow for avoiding the eval step on each deserialization, comparison is by md5
 *
 * @ignore
 * @api private
 */
var functionCache = BSON.functionCache = {};

/**
 * Number BSON Type
 *
 * @classconstant BSON_DATA_NUMBER
 **/
BSON.BSON_DATA_NUMBER = 1;
/**
 * String BSON Type
 *
 * @classconstant BSON_DATA_STRING
 **/
BSON.BSON_DATA_STRING = 2;
/**
 * Object BSON Type
 *
 * @classconstant BSON_DATA_OBJECT
 **/
BSON.BSON_DATA_OBJECT = 3;
/**
 * Array BSON Type
 *
 * @classconstant BSON_DATA_ARRAY
 **/
BSON.BSON_DATA_ARRAY = 4;
/**
 * Binary BSON Type
 *
 * @classconstant BSON_DATA_BINARY
 **/
BSON.BSON_DATA_BINARY = 5;
/**
 * ObjectID BSON Type
 *
 * @classconstant BSON_DATA_OID
 **/
BSON.BSON_DATA_OID = 7;
/**
 * Boolean BSON Type
 *
 * @classconstant BSON_DATA_BOOLEAN
 **/
BSON.BSON_DATA_BOOLEAN = 8;
/**
 * Date BSON Type
 *
 * @classconstant BSON_DATA_DATE
 **/
BSON.BSON_DATA_DATE = 9;
/**
 * null BSON Type
 *
 * @classconstant BSON_DATA_NULL
 **/
BSON.BSON_DATA_NULL = 10;
/**
 * RegExp BSON Type
 *
 * @classconstant BSON_DATA_REGEXP
 **/
BSON.BSON_DATA_REGEXP = 11;
/**
 * Code BSON Type
 *
 * @classconstant BSON_DATA_CODE
 **/
BSON.BSON_DATA_CODE = 13;
/**
 * Symbol BSON Type
 *
 * @classconstant BSON_DATA_SYMBOL
 **/
BSON.BSON_DATA_SYMBOL = 14;
/**
 * Code with Scope BSON Type
 *
 * @classconstant BSON_DATA_CODE_W_SCOPE
 **/
BSON.BSON_DATA_CODE_W_SCOPE = 15;
/**
 * 32 bit Integer BSON Type
 *
 * @classconstant BSON_DATA_INT
 **/
BSON.BSON_DATA_INT = 16;
/**
 * Timestamp BSON Type
 *
 * @classconstant BSON_DATA_TIMESTAMP
 **/
BSON.BSON_DATA_TIMESTAMP = 17;
/**
 * Long BSON Type
 *
 * @classconstant BSON_DATA_LONG
 **/
BSON.BSON_DATA_LONG = 18;
/**
 * MinKey BSON Type
 *
 * @classconstant BSON_DATA_MIN_KEY
 **/
BSON.BSON_DATA_MIN_KEY = 0xff;
/**
 * MaxKey BSON Type
 *
 * @classconstant BSON_DATA_MAX_KEY
 **/
BSON.BSON_DATA_MAX_KEY = 0x7f;

/**
 * Binary Default Type
 *
 * @classconstant BSON_BINARY_SUBTYPE_DEFAULT
 **/
BSON.BSON_BINARY_SUBTYPE_DEFAULT = 0;
/**
 * Binary Function Type
 *
 * @classconstant BSON_BINARY_SUBTYPE_FUNCTION
 **/
BSON.BSON_BINARY_SUBTYPE_FUNCTION = 1;
/**
 * Binary Byte Array Type
 *
 * @classconstant BSON_BINARY_SUBTYPE_BYTE_ARRAY
 **/
BSON.BSON_BINARY_SUBTYPE_BYTE_ARRAY = 2;
/**
 * Binary UUID Type
 *
 * @classconstant BSON_BINARY_SUBTYPE_UUID
 **/
BSON.BSON_BINARY_SUBTYPE_UUID = 3;
/**
 * Binary MD5 Type
 *
 * @classconstant BSON_BINARY_SUBTYPE_MD5
 **/
BSON.BSON_BINARY_SUBTYPE_MD5 = 4;
/**
 * Binary User Defined Type
 *
 * @classconstant BSON_BINARY_SUBTYPE_USER_DEFINED
 **/
BSON.BSON_BINARY_SUBTYPE_USER_DEFINED = 128;

// BSON MAX VALUES
BSON.BSON_INT32_MAX = 0x7FFFFFFF;
BSON.BSON_INT32_MIN = -0x80000000;

BSON.BSON_INT64_MAX = Math.pow(2, 63) - 1;
BSON.BSON_INT64_MIN = -Math.pow(2, 63);

// JS MAX PRECISE VALUES
BSON.JS_INT_MAX = 0x20000000000000;  // Any integer up to 2^53 can be precisely represented by a double.
BSON.JS_INT_MIN = -0x20000000000000;  // Any integer down to -2^53 can be precisely represented by a double.

// Internal long versions
var JS_INT_MAX_LONG = Long.fromNumber(0x20000000000000);  // Any integer up to 2^53 can be precisely represented by a double.
var JS_INT_MIN_LONG = Long.fromNumber(-0x20000000000000);  // Any integer down to -2^53 can be precisely represented by a double.

var deserialize = function(buffer, options, isArray) {
	var index = 0;
	// Read the document size
  var size = buffer[index++] | buffer[index++] &lt;&lt; 8 | buffer[index++] &lt;&lt; 16 | buffer[index++] &lt;&lt; 24;

	// Ensure buffer is valid size
  if(size &lt; 5 || buffer.length &lt; size) {
		throw new Error(&quot;corrupt bson message&quot;);
	}

	// Illegal end value
	if(buffer[size - 1] != 0) {
		throw new Error(&quot;One object, sized correctly, with a spot for an EOO, but the EOO isn&#039;t 0x00&quot;);
	}

	// Start deserializtion
	return deserializeObject(buffer, options, isArray);
}

// // Reads in a C style string
// var readCStyleStringSpecial = function(buffer, index) {
// 	// Get the start search index
// 	var i = index;
// 	// Locate the end of the c string
// 	while(buffer[i] !== 0x00 &amp;&amp; i &lt; buffer.length) {
// 		i++
// 	}
// 	// If are at the end of the buffer there is a problem with the document
// 	if(i &gt;= buffer.length) throw new Error(&quot;Bad BSON Document: illegal CString&quot;)
// 	// Grab utf8 encoded string
// 	var string = buffer.toString(&#039;utf8&#039;, index, i);
// 	// Update index position
// 	index = i + 1;
// 	// Return string
// 	return {s: string, i: index};
// }

// Reads in a C style string
var readCStyleStringSpecial = function(buffer, index) {
	// Get the start search index
	var i = index;
	// Locate the end of the c string
	while(buffer[i] !== 0x00 &amp;&amp; i &lt; buffer.length) {
		i++
	}
	// If are at the end of the buffer there is a problem with the document
	if(i &gt;= buffer.length) throw new Error(&quot;Bad BSON Document: illegal CString&quot;)
	// Grab utf8 encoded string
	return buffer.toString(&#039;utf8&#039;, index, i);
}

var DeserializationMethods = {}
DeserializationMethods[BSON.BSON_DATA_OID] = function(name, object, buffer, index) {
	var string = buffer.toString(&#039;binary&#039;, index, index + 12);
	object[name] = new ObjectID(string);
	return index + 12;
}

DeserializationMethods[BSON.BSON_DATA_NUMBER] = function(name, object, buffer, index) {
	object[name] = buffer.readDoubleLE(index);
  return index + 8;
}

DeserializationMethods[BSON.BSON_DATA_INT] = function(name, object, buffer, index) {
	object[name] = buffer.readInt32LE(index);
	return index + 4;
}

DeserializationMethods[BSON.BSON_DATA_TIMESTAMP] = function(name, object, buffer, index) {
  var lowBits = buffer[index++] | buffer[index++] &lt;&lt; 8 | buffer[index++] &lt;&lt; 16 | buffer[index++] &lt;&lt; 24;
  var highBits = buffer[index++] | buffer[index++] &lt;&lt; 8 | buffer[index++] &lt;&lt; 16 | buffer[index++] &lt;&lt; 24;
  object[name] = new Timestamp(lowBits, highBits);
	return index;
}

DeserializationMethods[BSON.BSON_DATA_STRING] = function(name, object, buffer, index) {
  var stringSize = buffer[index++] | buffer[index++] &lt;&lt; 8 | buffer[index++] &lt;&lt; 16 | buffer[index++] &lt;&lt; 24;
	if(stringSize &lt;= 0 || stringSize &gt; (buffer.length - index) || buffer[index + stringSize - 1] != 0) throw new Error(&quot;bad string length in bson&quot;);
  object[name] = buffer.toString(&#039;utf8&#039;, index, index + stringSize - 1);
  return index + stringSize;
}

DeserializationMethods[BSON.BSON_DATA_BOOLEAN] = function(name, object, buffer, index) {
  object[name] = buffer[index++] == 1;
	return index;
}

var deserializeObject = function(buffer, options, isArray) {
  // Options
  options = options == null ? {} : options;
  var evalFunctions = options[&#039;evalFunctions&#039;] == null ? false : options[&#039;evalFunctions&#039;];
  var cacheFunctions = options[&#039;cacheFunctions&#039;] == null ? false : options[&#039;cacheFunctions&#039;];
  var cacheFunctionsCrc32 = options[&#039;cacheFunctionsCrc32&#039;] == null ? false : options[&#039;cacheFunctionsCrc32&#039;];
  var promoteLongs = options[&#039;promoteLongs&#039;] == null ? true : options[&#039;promoteLongs&#039;];
	var fieldsAsRaw = options[&#039;fieldsAsRaw&#039;] == null ? {} : options[&#039;fieldsAsRaw&#039;];
  // Return BSONRegExp objects instead of native regular expressions
  var bsonRegExp = typeof options[&#039;bsonRegExp&#039;] == &#039;boolean&#039; ? options[&#039;bsonRegExp&#039;] : false;
  var promoteBuffers = options[&#039;promoteBuffers&#039;] == null ? false : options[&#039;promoteBuffers&#039;];

  // Validate that we have at least 4 bytes of buffer
  if(buffer.length &lt; 5) throw new Error(&quot;corrupt bson message &lt; 5 bytes long&quot;);

  // Set up index
  var index = typeof options[&#039;index&#039;] == &#039;number&#039; ? options[&#039;index&#039;] : 0;

	// Read the document size
  var size = buffer[index++] | buffer[index++] &lt;&lt; 8 | buffer[index++] &lt;&lt; 16 | buffer[index++] &lt;&lt; 24;

	// Ensure buffer is valid size
  if(size &lt; 5 || size &gt; buffer.length) throw new Error(&quot;corrupt bson message&quot;);

  // Create holding object
  var object = isArray ? [] : {};

  // While we have more left data left keep parsing
  while(true) {
    // Read the type
    var elementType = buffer[index++];
    // If we get a zero it&#039;s the last byte, exit
    if(elementType == 0) break;
    var name = readCStyleStringSpecial(buffer, index);
		index = index + name.length + 1;

		// console.log(&quot;----------- 0 &quot; + elementType + &quot; :: &quot; + name)
		index = DeserializationMethods[elementType](name, object, buffer, index);
		// console.log(&#039;--------------- 1&#039;)
  }

  // Check if we have a db ref object
  if(object[&#039;$id&#039;] != null) object = new DBRef(object[&#039;$ref&#039;], object[&#039;$id&#039;], object[&#039;$db&#039;]);

  // Return the final objects
  return object;
}

/**
 * Ensure eval is isolated.
 *
 * @ignore
 * @api private
 */
var isolateEvalWithHash = function(functionCache, hash, functionString, object) {
  // Contains the value we are going to set
  var value = null;

  // Check for cache hit, eval if missing and return cached function
  if(functionCache[hash] == null) {
    eval(&quot;value = &quot; + functionString);
    functionCache[hash] = value;
  }
  // Set the object
  return functionCache[hash].bind(object);
}

/**
 * Ensure eval is isolated.
 *
 * @ignore
 * @api private
 */
var isolateEval = function(functionString) {
  // Contains the value we are going to set
  var value = null;
  // Eval the function
  eval(&quot;value = &quot; + functionString);
  return value;
}

module.exports = deserialize</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ cyclomatic }} <br>
    Length : {{ halstead.length }} <br>
    Difficulty : {{ halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
